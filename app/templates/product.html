{% extends "base.html" %}

{% block content %}
        <div class="product-image">
                <img src="{{ product.image_url }}" alt="{{ product.name }}" style="max-width: 300px; max-height: 300px;">
        </div>
        <h1>Product: {{ product.name }}</h1>
        <p>Type: {{ product.type }}</p>
        <p>Description: {{ product.description }}</p>
        <p>Status: {{ product.status }}</p>

<!-- Календарь -->
<table border="1">
    <tr>
        <th>Пн</th><th>Вт</th><th>Ср</th><th>Чт</th><th>Пт</th><th>Сб</th><th>Вс</th>
    </tr>
    {% for week in calendar %}
    <tr>
        {% for day in week %}
        <td onclick="handleDateClick('{{ day }}')" 
            id="day-{{ day }}"
            {% if day == 0 %}style="background: #eee"{% endif %}
            {% if day != 0 and day < today %}style="background: #ccc"{% endif %}
            {% if day != 0 and day in booked_days %}style="background: #ffdddd"{% endif %}>
            {% if day != 0 %}{{ day.split('-')[2] }}{% endif %}
        </td>
        {% endfor %}
    </tr>
    {% endfor %}
</table>

<!-- Форма бронирования -->
<form method="POST" action="{{ url_for('book_product', product_id=product.id) }}">
    <input type="hidden" name="start_date" id="start_date">
    <input type="hidden" name="end_date" id="end_date">
    
    <p>Выбранные даты: <span id="selected-dates"></span></p>
    <p>Место получения: <input type="text" name="location" required></p>
    <button type="submit">Забронировать</button>
</form>

<script>
function isDateBooked(date) {
    const dayElement = document.querySelector(`td[onclick*="${date}"]`);
    return dayElement && dayElement.style.backgroundColor === 'rgb(204, 204, 204)';
}

let selectedDates = [];

function handleDateClick(date) {
    if (date === '0' || isDateBooked(date)) return; // То, что забронировано, не показывается 
    if (date === '0') return; // Пустые ячейки
    
    // Проверяем, доступна ли дата
    const dayElement = document.getElementById(`day-${date}`);
    if (dayElement.style.backgroundColor === 'rgb(204, 204, 204)' || 
        dayElement.style.backgroundColor === 'rgb(255, 221, 221)') {
        return; // Нельзя выбрать прошедшие или занятые даты
    }

    // Логика выбора диапазона
    if (selectedDates.length === 0) {
        // Первая дата
        selectedDates = [date];
        dayElement.style.backgroundColor = '#aaffaa';
    } else if (selectedDates.length === 1) {
        // Вторая дата
        selectedDates.push(date);
        selectedDates.sort();
        
        // Подсвечиваем весь диапазон
        highlightDateRange(selectedDates[0], selectedDates[1]);
    } else {
        // Сброс выбора
        resetSelection();
        selectedDates = [date];
        dayElement.style.backgroundColor = '#aaffaa';
    }
    
    // Обновляем скрытые поля формы
    document.getElementById('start_date').value = selectedDates[0];
    document.getElementById('end_date').value = selectedDates[1] || selectedDates[0];
    document.getElementById('selected-dates').textContent = selectedDates.join(' - ');
}

function highlightDateRange(start, end) {
    resetSelection();
    
    const startDate = new Date(start);
    const endDate = new Date(end);
    const currentDate = new Date(startDate);
    
    while (currentDate <= endDate) {
        const dateStr = currentDate.toISOString().split('T')[0];
        const dayElement = document.getElementById(`day-${dateStr}`);
        if (dayElement) {
            dayElement.style.backgroundColor = '#aaffaa';
        }
        currentDate.setDate(currentDate.getDate() + 1);
    }

    // Форматируем даты для формы (YYYY-MM-DD)
    document.getElementById('start_date').value = selectedDates[0];
    document.getElementById('end_date').value = selectedDates[1] || selectedDates[0];
    
    // Показываем даты пользователю в удобном формате
    const displayFormat = selectedDates.map(d => {
        const [y, m, day] = d.split('-');
        return `${day}.${m}.${y}`;
    }).join(' - ');
    
    document.getElementById('selected-dates').textContent = displayFormat;
}

function resetSelection() {
    document.querySelectorAll('td').forEach(td => {
        if (td.style.backgroundColor === 'rgb(170, 255, 170)') {
            td.style.backgroundColor = '';
        }
    });
}
</script>
{% endblock %}